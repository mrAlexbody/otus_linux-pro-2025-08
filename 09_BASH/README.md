# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ 09
## –ü–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç

### –¶–µ–ª—å: 
–ù–∞–ø–∏—Å–∞—Ç—å bash-—Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –µ–∂–µ—á–∞—Å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ email –æ—Ç—á—ë—Ç –æ —Ä–∞–±–æ—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞;

### –û–ø–∏—Å–∞–Ω–∏–µ/–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
**üéØ–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?**

–ù–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è CRON, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑ –≤ —á–∞—Å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é –ø–æ—á—Ç—É.

#### –û—Ç—á—ë—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

+ IP-–∞–¥—Ä–µ—Å–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞);
+ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ URL —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞);
+ –û—à–∏–±–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞);
+ HTTP-–∫–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞).

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–ø–∏–π, –¥–æ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

–í –ø–∏—Å—å–º–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–ø–∏—Å–∞–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω.

---
### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:
````shell
root@otus-bash:~# apt install -y msmtp msmtp-mta mailutils nginx
````

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞:
```shell
root@otus-bash:/usr/local/bin# cat ./web_report.sh
#!/bin/bash

readonly LOG_DIR="/var/log/nginx"
readonly LOG_PATTERN="access*.log"
readonly EMAIL="admin@gmail.com"
readonly LOCKFILE="/tmp/web_report.lock"
readonly STATE_FILE="/var/tmp/web_report.state"
readonly REPORT_FILE="/tmp/web_report_$(date +%Y%m%d_%H%M%S).txt"
readonly TIMESTAMP_FORMAT="%d/%b/%Y:%H:%M:%S"

cleanup() {
    local exit_code=$?
    echo "–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤..."
    rm -f "$LOCKFILE" 2>/dev/null
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —Å—Ç–∞—Ä—à–µ 2 —á–∞—Å–æ–≤
    find /tmp -name "web_report_*.txt" -mmin +120 -delete 2>/dev/null
    exit $exit_code
}

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >&2
}

check_dependencies() {
    local deps=("mail" "flock" "awk" "sed" "find")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            log_message "–û—à–∏–±–∫–∞: $dep –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            return 1
        fi
    done

    if [ ! -d "$LOG_DIR" ]; then
        log_message "–û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $LOG_DIR"
        return 1
    fi
}

find_log_files() {
    find "$LOG_DIR" -name "$LOG_PATTERN" -type f -mmin -120 2>/dev/null | sort
}

extract_log_data() {
    local log_files=$1
    local start_time=$2
    local end_time=$3

    awk -v start="$start_time" -v end="$end_time" '
    function parse_time(str) {
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        gsub(/\[/, "", str)
        return str
    }
    {
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è –∏–∑ –ª–æ–≥–∞ (4-–µ –ø–æ–ª–µ –≤ nginx)
        log_time = parse_time($4)
        if (log_time >= start && log_time <= end) {
            print $0
        }
    }' $log_files
}

generate_report() {
    local data=$1
    local start_time=$2
    local end_time=$3

    cat <<EOF > "$REPORT_FILE"
–û—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
–í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω: $start_time - $end_time
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: $(date '+%Y-%m-%d %H:%M:%S')
==================================================

1. –¢–û–ü-10 IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤:
$(echo "$data" | awk '{print $1}' | sort | uniq -c | sort -rn | head -10 | awk '{printf "%s\t%s\n", $1, $2}')

2. –¢–û–ü-10 –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö URL:
$(echo "$data" | awk '{print $7}' | sort | uniq -c | sort -rn | head -10 | awk '{printf "%s\t%s\n", $1, $2}')

3. –û—à–∏–±–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (4xx –∏ 5xx):
$(echo "$data" | awk '$9 ~ /^[45][0-9][0-9]$/ {print $1, $4, $7, $9}' | head -20)

4. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ HTTP-–∫–æ–¥–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤:
$(echo "$data" | awk '{code=$9; if (code ~ /^[0-9][0-9][0-9]$/) codes[code]++} END {for (c in codes) printf "%s: %d\n", c, codes[c]}' | sort -rn)

5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Ç–æ–¥–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤:
$(echo "$data" | awk '{print $6}' | sed 's/"//g' | sort | uniq -c | sort -rn)

==================================================
–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤: $(echo "$data" | wc -l)
EOF
}

trap cleanup EXIT INT TERM

if ! check_dependencies; then
    exit 1
fi

exec 9>"$LOCKFILE"
if ! flock -n 9; then
    log_message "–°–∫—Ä–∏–ø—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –í—ã—Ö–æ–¥."
    exit 1
fi

START_TIME=$(date -d "1 hour ago" "+$TIMESTAMP_FORMAT")
END_TIME=$(date "+$TIMESTAMP_FORMAT")

log_message "–ù–∞—á–∞–ª–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥: $START_TIME - $END_TIME"

LOG_FILES=$(find_log_files)
if [ -z "$LOG_FILES" ]; then
    log_message "–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ª–æ–≥-—Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"
    exit 0
fi

log_message "–ù–∞–π–¥–µ–Ω—ã –ª–æ–≥-—Ñ–∞–π–ª—ã: $(echo $LOG_FILES | tr '\n' ' ')"

LOG_DATA=$(extract_log_data "$LOG_FILES" "$START_TIME" "$END_TIME")

if [ -z "$LOG_DATA" ]; then
    log_message "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥"
    exit 0
fi

log_message "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: $(echo "$LOG_DATA" | wc -l)"

generate_report "$LOG_DATA" "$START_TIME" "$END_TIME"

if [ -s "$REPORT_FILE" ]; then
    mail -s "–û—Ç—á–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ $(date '+%Y-%m-%d %H:%M')" \
         -a "From: webserver-report@$(hostname)" \
         "$EMAIL" < "$REPORT_FILE"

    if [ $? -eq 0 ]; then
        log_message "–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ $EMAIL"
    else
        log_message "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞"
        exit 1
    fi
fi

log_message "–°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
```
### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞:
```shell
root@otus-bash:~#  chmod +x /usrlocal/bin/web_repor.sh
root@otus-bash:~# ls -la /usr/local/bin/web_report.sh
-rwxr-xr-x 1 root root 5484 Jan 14 18:57 /usr/local/bin/web_report.sh
```
### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ crontab:
```shell
root@otus-bash:~#  crontab -e


# Edit this file to introduce tasks to be run by cron.
#
# Each task to run has to be defined through a single line
# indicating with different fields when the task will be run
# and what command to run for the task
#
# To define the time you can provide concrete values for
# minute (m), hour (h), day of month (dom), month (mon),
# and day of week (dow) or use '*' in these fields (for 'any').
#
# Notice that tasks will be started based on the cron's system
# daemon's notion of time and timezones.
#
# Output of the crontab jobs (including errors) is sent through
# email to the user the crontab file belongs to (unless redirected).
#
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
#
# For more information see the manual pages of crontab(5) and cron(8)
#
# m h  dom mon dow   command
0 * * * * /usr/local/bin/web_report.sh  >> /var/log/web_report.log 2>&1
```
